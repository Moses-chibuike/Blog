---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { Calendar, User, ArrowLeft, Share2, Heart, MessageCircle } from 'lucide-astro';
---

<Layout title="Blog Post - AlaoMe" description="Read inspiring stories of transformation">
  <Header />
  
  <!-- Blog Post Content will be loaded dynamically -->
  <div id="blog-content">
    <!-- Loading State -->
    <div id="loading-state" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mb-4"></div>
        <p class="text-gray-600">Loading story...</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="min-h-screen flex items-center justify-center hidden">
      <div class="text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Story Not Found</h1>
        <p class="text-gray-600 mb-4">The story you're looking for doesn't exist or has been removed.</p>
        <a href="/blog" class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-500 transition-colors">
          <ArrowLeft size={16} class="mr-2" />
          Back to Blog
        </a>
      </div>
    </div>
  </div>

  <Footer />
</Layout>

<script>
  import { postStorage } from '../../utils/postStorage.js';

  document.addEventListener('DOMContentLoaded', function() {
    const blogContent = document.getElementById('blog-content');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    
    // Get slug from URL
    const pathParts = window.location.pathname.split('/');
    const slug = pathParts[pathParts.length - 1];
    
    if (!slug) {
      showError();
      return;
    }
    
    // Load post
    loadPost(slug);
    
    function loadPost(slug) {
      try {
        const post = postStorage.getPostBySlug(slug);
        
        if (!post) {
          showError();
          return;
        }
        
        // Update page title
        document.title = `${post.title} - AlaoMe Blog`;
        
        // Update meta description
        const metaDescription = document.querySelector('meta[name="description"]');
        if (metaDescription) {
          metaDescription.setAttribute('content', post.excerpt);
        }
        
        // Render post
        renderPost(post);
        
        // Increment view count
        incrementViews(post.id);
        
      } catch (error) {
        console.error('Error loading post:', error);
        showError();
      }
    }
    
    function renderPost(post) {
      // Get related posts
      const relatedPosts = getRelatedPosts(post);
      
      const postHTML = `
        <!-- Blog Post Header -->
        <article class="bg-white">
          <!-- Back Navigation -->
          <div class="bg-gray-50 py-4 border-b">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
              <a 
                href="/blog"
                class="inline-flex items-center text-primary-600 hover:text-primary-700 font-medium transition-colors"
              >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Blog
              </a>
            </div>
          </div>

          <!-- Hero Image -->
          <div class="relative h-96 md:h-[500px] overflow-hidden">
            <img 
              src="${post.image}" 
              alt="${post.title}"
              class="w-full h-full object-cover"
              onerror="this.src='https://images.pexels.com/photos/6646917/pexels-photo-6646917.jpeg?auto=compress&cs=tinysrgb&w=1200&h=800&fit=crop'"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
            
            <!-- Category Badge -->
            ${post.category ? `
              <div class="absolute top-6 left-6">
                <span class="bg-primary-500 text-white px-4 py-2 rounded-full text-sm font-medium">
                  ${post.category}
                </span>
              </div>
            ` : ''}
            
            ${post.featured ? `
              <div class="absolute top-6 right-6">
                <span class="bg-yellow-500 text-white px-4 py-2 rounded-full text-sm font-medium">
                  Featured
                </span>
              </div>
            ` : ''}
          </div>

          <!-- Post Content -->
          <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <!-- Post Meta -->
            <div class="mb-8">
              <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 leading-tight mb-6">
                ${post.title}
              </h1>
              
              <div class="flex flex-wrap items-center text-gray-600 text-sm space-x-6 mb-6">
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <span>${post.author}</span>
                </div>
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 011-1h6a1 1 0 011 1v4h3a1 1 0 110 2h-1v9a2 2 0 01-2 2H7a2 2 0 01-2-2V9H4a1 1 0 110-2h4z"></path>
                  </svg>
                  <span>${post.date}</span>
                </div>
                <div class="flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                  <span>${post.views || 0} views</span>
                </div>
              </div>

              <!-- Social Sharing -->
              <div class="flex items-center space-x-4 pb-8 border-b">
                <span class="text-sm font-medium text-gray-700">Share:</span>
                <button onclick="sharePost('facebook')" class="flex items-center justify-center w-10 h-10 bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-600 rounded-full transition-colors">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                  </svg>
                </button>
                <button onclick="sharePost('twitter')" class="flex items-center justify-center w-10 h-10 bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-600 rounded-full transition-colors">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                  </svg>
                </button>
                <button onclick="copyLink()" class="flex items-center justify-center w-10 h-10 bg-gray-100 hover:bg-green-100 text-gray-600 hover:text-green-600 rounded-full transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Article Content -->
            <div class="prose prose-lg max-w-none">
              <div class="post-content">${post.content}</div>
            </div>

            <!-- Call to Action -->
            <div class="mt-12 p-8 bg-primary-50 rounded-xl border border-primary-200">
              <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">
                  Help Us Transform More Lives
                </h3>
                <p class="text-gray-600 mb-6">
                  Your support makes stories like this possible. Join us in creating lasting change in communities around the world.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                  <a 
                    href="/donate"
                    class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-500 transition-colors"
                  >
                    Make a Donation
                  </a>
                  <a 
                    href="/volunteer"
                    class="inline-flex items-center justify-center px-6 py-3 text-base font-medium text-primary-600 bg-white border border-primary-600 rounded-lg hover:bg-primary-50 transition-colors"
                  >
                    Become a Volunteer
                  </a>
                </div>
              </div>
            </div>

            <!-- Related Posts -->
            ${relatedPosts.length > 0 ? `
              <div class="mt-16 border-t pt-12">
                <h3 class="text-2xl font-bold text-gray-900 mb-8">Related Stories</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                  ${relatedPosts.map(relatedPost => `
                    <a href="/blog/${relatedPost.slug}" class="group">
                      <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden">
                        <div class="relative overflow-hidden h-48">
                          <img 
                            src="${relatedPost.image}" 
                            alt="${relatedPost.title}"
                            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                            onerror="this.src='https://images.pexels.com/photos/6646917/pexels-photo-6646917.jpeg?auto=compress&cs=tinysrgb&w=800&h=600&fit=crop'"
                          />
                          ${relatedPost.category ? `
                            <div class="absolute top-4 left-4">
                              <span class="bg-primary-500 text-white px-3 py-1 rounded-full text-xs font-medium">
                                ${relatedPost.category}
                              </span>
                            </div>
                          ` : ''}
                        </div>
                        <div class="p-6">
                          <h4 class="text-lg font-bold text-gray-900 mb-2 group-hover:text-primary-600 transition-colors">
                            ${relatedPost.title}
                          </h4>
                          <div class="flex items-center text-sm text-gray-500 space-x-4">
                            <span>${relatedPost.author}</span>
                            <span>${relatedPost.date}</span>
                          </div>
                        </div>
                      </div>
                    </a>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </article>
      `;
      
      loadingState.classList.add('hidden');
      blogContent.innerHTML = postHTML;
    }
    
    function getRelatedPosts(currentPost) {
      try {
        const allPosts = postStorage.getPublishedPosts();
        return allPosts
          .filter(post => post.id !== currentPost.id && post.category === currentPost.category)
          .slice(0, 2);
      } catch (error) {
        console.error('Error getting related posts:', error);
        return [];
      }
    }
    
    function incrementViews(postId) {
      try {
        const post = postStorage.getPostById(postId);
        if (post) {
          postStorage.updatePost(postId, {
            views: (post.views || 0) + 1
          });
        }
      } catch (error) {
        console.error('Error incrementing views:', error);
      }
    }
    
    function showError() {
      loadingState.classList.add('hidden');
      errorState.classList.remove('hidden');
    }
    
    // Global functions for sharing
    window.sharePost = function(platform) {
      const url = window.location.href;
      const title = document.title;
      
      let shareUrl = '';
      
      switch (platform) {
        case 'facebook':
          shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
          break;
        case 'twitter':
          shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
          break;
      }
      
      if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
      }
    };
    
    window.copyLink = function() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        showNotification('Link copied to clipboard!', 'success');
      }).catch(() => {
        showNotification('Failed to copy link', 'error');
      });
    };
    
    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${
        type === 'success' ? 'bg-green-600 text-white' : 
        type === 'error' ? 'bg-red-600 text-white' : 
        'bg-blue-600 text-white'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 100);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }
  });
</script>

<style>
  .prose h2 {
    @apply text-2xl font-bold text-gray-900 mt-8 mb-4;
  }
  
  .prose h3 {
    @apply text-xl font-bold text-gray-900 mt-6 mb-3;
  }
  
  .prose p {
    @apply text-gray-700 leading-relaxed mb-4;
  }
  
  .prose ul {
    @apply list-disc list-inside space-y-2 text-gray-700 mb-4;
  }
  
  .prose li {
    @apply leading-relaxed;
  }
  
  .prose a {
    @apply text-primary-600 hover:text-primary-700 underline;
  }
  
  .post-content img {
    @apply max-w-full h-auto rounded-lg shadow-sm my-6;
  }
</style>